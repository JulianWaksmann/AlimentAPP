Flujo de Asignacion de Materia Prima
===================================

Documentos relacionados
-----------------------
- 03_flujo_orden_venta.txt (dispara la necesidad).
- 04_flujo_materia_prima.txt (gestiona lotes y requisiciones).
- 01_schema_postgres.txt (DDL de tablas involucradas).
- 02_data_dictionary.txt (definiciones de campos y estados).

Objetivo
--------
Reservar automaticamente y sin intervencion manual la materia prima necesaria para cada orden de produccion (OP) garantizando trazabilidad por lote y manteniendo la disponibilidad del stock en lotes.

Lineas de produccion
--------------------
- Existen dos lineas principales: "Masas" (tartas, pizzas y derivados de harina) y "Carnes" (rellenos o bases con carne).
- Cada linea se modela en linea_produccion con su capacidad_maxima_kg y estado de disponibilidad.
- La tabla producto_por_linea_produccion asigna cada producto a una linea (y permite priorizar cuando un producto puede correr en mas de una).
- Solo el encargado de calidad interviene manualmente al dar de alta lotes; el resto del proceso es automatico.

Entradas clave
--------------
- orden_produccion: cantidad solicitada, linea asignada y estado actual.
- producto.peso_unitario_kg: peso por unidad para convertir unidades a kilogramos.
- materia_prima_por_producto: receta que indica cuanta materia prima consume cada unidad del producto.
- materia_prima_por_orden_produccion: asignaciones ya registradas (consumo historico o parcial).
- lote_materia_prima: lotes disponibles con sus cantidades y fechas de vencimiento.

Resumen del proceso
-------------------
1. Se activa automaticamente cuando la orden de venta pasa a confirmada o cuando calidad libera un lote (estado pasa a disponible).
2. Para cada OP pendiente de materia prima:
   - Calcular la carga total en kilogramos (cantidad * peso_unitario_kg).
   - Calcular el requerimiento por materia prima aplicando la receta.
   - Obtener lo ya asignado en materia_prima_por_orden_produccion.
   - Determinar el faltante por materia prima (faltante = necesario - asignado).
3. Si el faltante > 0, buscar lotes disponibles aplicando FEFO (fecha de vencimiento mas proxima, siempre >= hoy + 14 dias).
4. Consumir lotes iterativamente (sin pasos manuales) hasta cubrir el faltante:
   - Registrar cada consumo en materia_prima_por_orden_produccion.
   - Restar cantidad_disponible y actualizar estado del lote (a gotado si llega a 0).
5. Si la suma de lotes no cubre el faltante, registrar requisicion y dejar la OP en estado pendiente; unicamente el alta de nuevos lotes (por calidad) reactivara el flujo.
6. Si se cubre la necesidad, cambiar la OP a lista_para_produccion con el peso asignado en kg_programados.

Algoritmo de particion por capacidad
------------------------------------
1. Obtener la linea candidata desde producto_por_linea_produccion (o categoria por defecto).
2. Calcular la carga total en kg (cantidad * peso_unitario_kg).
3. Comparar con capacidad_maxima_kg de la linea.
   - Si la carga <= capacidad, registrar la OP con kg_programados igual a la carga.
   - Si excede la capacidad, dividir la carga en bloques: crear ordenes de produccion hijas, cada una <= capacidad.
4. Recalcular cantidad (unidades) por cada sub-orden usando peso_unitario_kg para mantener la equivalencia.
5. Asignar la linea y kg_programados a cada sub-orden y ejecutar el proceso de asignacion de lotes sobre cada una.
6. Registrar en orden_produccion_linea cada bloque generado, manteniendo id_orden_produccion como vinculo con la cabecera.

Reglas de negocio
-----------------
- FEFO estricto: siempre consumir el lote con vencimiento mas cercano dentro del umbral aceptado (>= 14 dias).
- Solo se consumen lotes disponible; lotes en_cuarentena, echazado, encido o gotado no participan.
- Procesos idempotentes: ejecutar dos veces con los mismos datos no debe duplicar asignaciones.
- Requiere transaccion/locking para evitar carreras cuando hay multiples asignaciones simultaneas; no requiere intervencion humana durante la asignacion.
- Si un lote asignado queda sin stock, su estado pasa a gotado; si su fecha de vencimiento llega a hoy, se marca encido.
- Si aparece un nuevo lote o se libera uno rechazado, el proceso retoma automaticamente las OP con faltante.

Diagrama ASCII
--------------

             +-----------------------+
             | OP pendiente de lote  |
             | (estado planificada)  |
             +-----------+-----------+
                         |
                         v
             +-----------------------+
             | Calcular necesidad    |
             | total por materia     |
             +-----------+-----------+
                         |
             +-----------v-----------+
             | Calcular faltante     |
             | (necesario - asignado)|
             +-----------+-----------+
                         |
            +------------v------------+
            | faltante > 0 ?          |
            +------+------------------+
                   |SI               |NO
                   |                v
                   |      +---------------------+
                   |      | OP lista_para_      |
                   |      | produccion          |
                   |      +---------------------+
                   |
                   v
      +--------------------------+
      | Buscar lote disponible   |
      | (FEFO, venc >= hoy+14)   |
      +-----------+--------------+
                  |
            +-----v---------------+
            | Existe lote?        |
            +------+--------------+
                   |SI           |NO
                   |            v
                   |    +-----------------------+
                   |    | Generar requisicion   |
                   |    | y notificar           |
                   |    +-----------+-----------+
                   |                |
                   |                v
                   |    (esperar nuevos lotes)
                   |
                   v
      +------------------------------+
      | Consumir lote                |
      | - insertar en m_p_por_OP     |
      | - restar cantidad_disponible |
      | - actualizar estado de lote  |
      +-----------+------------------+
                  |
                  v (si faltante>0 continuar)

Implementacion sugerida
-----------------------
- **Opcion Lambda (recomendada):**
  - Lambda en Python ejecutada cuando se confirma una orden de venta y cuando un lote cambia a disponible.
  - Usa transacciones con nivel de aislamiento apropiado (o locking por SELECT FOR UPDATE) para actualizar lotes y materia_prima_por_orden_produccion.
  - Ventajas: logica versionada junto al codigo, facil de extender, centraliza auditoria, no requiere funciones complejas en la base.

- **Opcion stored procedure/trigger (alternativa):**
  - Stored procedure en PostgreSQL que se invoca desde la Lambda para encapsular consumo + actualizacion en la DB.
  - Trigger directo no recomendado (por FEFO + requisiciones) porque es mas dificil de mantener y auditar.

Recomendacion final
-------------------
Usar Lambdas como orquestadores:
1. Lambda handle_order_confirmation invoca la particion y asignacion al confirmar OV.
2. Lambda on_lot_released se ejecuta cuando calidad marca un lote como disponible.
3. Cada Lambda llama a un helper comun que ejecuta el algoritmo con transaccion y actualiza la DB via pg8000.
4. Si se necesita mayor atomicidad, encapsular el bloque critico en un stored procedure pero mantener la orquestacion y las decisiones de negocio en Lambda.

Notas adicionales
-----------------
- Registrar logs y auditorias (orden, materia prima, lote, cantidades, usuario/servicio) para monitorear el proceso automatico.
- Exponer estatus de asignacion en API para que Operario y Supervisor vean faltantes y divisiones.
- Agregar alertas cuando una OP permanezca con faltante por encima de cierto SLA.


\nInvocacion de la lambda\n------------------------\n- POST /post-asignar-materia-prima recibe opcionalmente ordenes_produccion (lista de IDs) y, si falta, procesa las OP planificadas en orden de llegada.\n- Para cada orden calcula el faltante por materia prima considerando lo ya consumido, selecciona lotes disponibles que no venzan en las proximas dos semanas y registra los consumos en materia_prima_por_orden_produccion.\n- Si todos los requerimientos quedan cubiertos, actualiza la OP a lista_para_produccion; de lo contrario mantiene el estado original y devuelve el faltante.
