Flujo de Planificacion de Lineas
================================

Documentos relacionados
-----------------------
- 03_flujo_orden_venta.txt (confirmacion de pedidos).
- 04_flujo_materia_prima.txt (reservas de lotes).
- 05_flujo_asignacion_materia_prima.txt (consumo automatico por bloque).
- 01_schema_postgres.txt y 02_data_dictionary.txt.

Objetivo
--------
Dividir cada orden de produccion en tandas de fabrica segun las lineas compatibles, respetando la capacidad maxima y asignando ventanas de tres horas de manera automatica.

Entradas clave
--------------
- orden_produccion: cantidad total del producto y referencia a la orden de venta.
- producto_por_linea_produccion: relacion de compatibilidad producto-linea (con prioridad).
- linea_produccion: capacidad_maxima_kg, disponibilidad (activa) y categoria.
- producto.peso_unitario_kg: peso de cada unidad comercial.
- orden_produccion_linea: tabla destino donde se guardan los bloques por linea.
- orden_produccion_linea.fecha_inicio/fin: definen las tandas de 3 horas.

Resumen del proceso
-------------------
1. La orden de venta es confirmada y se generan las ordenes de produccion (estado planificada).
2. La lambda de planificacion recibe la referencia de la orden de venta u orden de produccion.
3. Para cada orden de produccion:
   - Se calcula la demanda total en kilogramos (`cantidad * peso_unitario_kg`).
   - Se obtiene la lista de lineas compatibles (ordenada por prioridad y disponibilidad).
   - Se determina la capacidad de cada linea en unidades (`capacidad_maxima_kg / peso_unitario_kg`).
4. Se limpian las asignaciones previas (`orden_produccion_linea`) para evitar duplicados.
5. Se reparte la carga en bloques:
   - Para cada linea, se agenda un bloque con unidades <= capacidad de la linea.
   - Si la demanda excede la capacidad, se repite la asignacion tantas veces como sea necesario (una sola linea recibe multiples tandas).
   - Cada tanda recibe un `estado_produccion = lista_para_produccion`.
6. Se asignan ventanas de tres horas: `fecha_inicio = max(now, ultima_fecha_fin_linea)` y `fecha_fin = fecha_inicio + 3h`.
7. Al crear el bloque, se invoca el flujo de asignacion de materia prima para reservar lotes. Si no hay stock, el bloque queda pendiente y se reintentara cuando calidad agregue lotes.
8. El operario ve los bloques por linea y cambia el estado a `en_proceso` cuando inicia y `finalizada` cuando termina. El estado global de la orden se deriva de sus bloques.

Diagrama ASCII
--------------

               +---------------------------+
               | Orden de produccion base  |
               | cantidad total (unidades) |
               +------------+--------------+
                            |
                            v
               +---------------------------+
               | Calcular demanda en kg    |
               | y lineas compatibles      |
               +------------+--------------+
                            |
                            v
               +---------------------------+
               | Repartir en bloques <=    |
               | capacidad de cada linea   |
               +------------+--------------+
                            |
                            v
               +---------------------------+
               | Crear registros en        |
               | orden_produccion_linea    |
               | con ventanas de 3 horas   |
               +------------+--------------+
                            |
                            v
               +---------------------------+
               | Asignar materia prima     |
               | (flujo automatico)        |
               +------------+--------------+
                            |
                            v
               +---------------------------+
               | Operario ejecuta y        |
               | actualiza estado          |
               +---------------------------+

Notas de negocio
----------------
- La capacidad y la categoria de la linea permiten separar familias (masas vs carnes).
- El algoritmo consume primero las lineas con mayor prioridad. Si solo existe una linea, se agendan tandas secuenciales en la misma.
- Los bloques mantienen trazabilidad completa: fechas, estado y cantidad despues de cada tanda.
- La duracion de 3 horas se puede parametrizar a futuro (columna configuracion o variable de entorno).
- Si una orden necesita reorganizacion (por ejemplo, nueva capacidad), la lambda elimina y recalcula los bloques.
