Flujo de Planificacion de Ordenes
=================================

Documentos relacionados
-----------------------
- 03_flujo_orden_venta.txt (confirmacion y generacion de OP).
- 04_flujo_materia_prima.txt (reservas de lotes por OP).
- 05_flujo_asignacion_materia_prima.txt (consumo automatico por orden).
- 01_schema_postgres.txt y 02_data_dictionary.txt.

Objetivo
--------
Permitir que el operario asigne una orden de produccion (OP) a una linea compatible y, si supera la capacidad, dividirla automaticamente en una nueva OP con la cantidad remanente.

Entradas clave
--------------
- orden_produccion: cabecera con cantidad total, producto y estado.
- producto_por_linea_produccion: compatibilidad producto-linea y prioridades.
- linea_produccion: capacidad_maxima_kg y estado (activa/inactiva).
- producto.peso_unitario_kg: peso de cada unidad comercial para respetar la capacidad.

Resumen del proceso
-------------------
1. El operario selecciona una OP y el sistema lista las lineas compatibles (desde producto_por_linea_produccion).
2. Al elegir una linea, el sistema calcula la capacidad maxima en unidades (`floor(capacidad_maxima_kg / peso_unitario_kg)`).
3. Si la cantidad de la OP <= capacidad, se registra la linea en la OP original (columna id_linea_produccion) y se deja `cantidad` intacta.
4. Si la cantidad supera la capacidad:
   - Se muestra un mensaje "excede la capacidad, ?deseas dividirla?".
   - Si el operario confirma, se realiza un `split`:
     * La OP original se actualiza con `cantidad = capacidad_en_unidades`.
     * Se inserta una nueva OP con la cantidad restante, mismo producto, id_orden_venta, fechas y observaciones (nuevo id serial).
     * La OP original queda asignada a la linea seleccionada; la nueva queda planificada y disponible para asignarse (posiblemente a la misma linea en un segundo turno u otra linea compatible).
   - Si el operario cancela, no se modifica la OP.
5. Siempre que se crea una OP nueva por division, se registra la observacion "Dividida desde OP <id_original>" para fines de trazabilidad.
6. Ambas OP (la original ajustada y la nueva) siguen el flujo de asignacion de materia prima y cambio de estado habitual.

Diagrama ASCII
--------------

             +---------------------------+
             | OP seleccionada por       |
             | operario                  |
             +------------+--------------+
                          |
                          v
             +---------------------------+
             | Calcular capacidad        |
             | unidades maximas         |
             +------------+--------------+
                          |
            +-------------v-------------+
            | Cantidad <= capacidad?    |
            +---------+-----------------+
                      |SI              |NO
                      |               v
                      |     +-------------------------+
                      |     | Mostrar dialogo de      |
                      |     | division y confirmar    |
                      |     +-----------+-------------+
                      |                 |
                      |                 v
                      |       +----------------------+      +------------------------+
                      |       | Actualizar OP actual |      | Crear nueva OP con     |
                      |       | (cantidad = capacidad)|      | cantidad restante      |
                      |       | y asignar linea       |      | (estado planificada)   |
                      |       +----------------------+      +------------------------+
                      |
                      v
             +---------------------------+
             | OP(s) listas para         |
             | asignacion de materia     |
             | prima y produccion        |
             +---------------------------+

Notas de negocio
----------------
- La division se realiza siempre en unidades, no en kilogramos, y evita que una linea se sature.
- Permite que una parte se ejecute en la linea seleccionada sin perder la cantidad restante: esta puede asignarse a la misma linea mas tarde o a otra linea compatible.
- Mantener un log de auditoria (observacion en la OP nueva) facilita rastrear las divisiones.
- No se requiere tabla intermedia: las OP resultantes son ordenes completas con su propio ciclo de estados y reservas de materia prima.
- El proceso de division puede invocarse desde la lambda de planificacion o desde la UI (segun se implemente).
